<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ë©€í‹° URL ë‹¤ìš´ë¡œë” v3</title>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <style>
        :root {
            --bg: #0f1115;
            --card: #141826;
            --muted: #9aa3ba;
            --text: #e9edff;
            --acc: #ff3000;
            --ok: #2ecc71;
            --warn: #f39c12;
            --err: #ff3b57
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            background: linear-gradient(180deg,#0f1115,#0b0d12);
            color: var(--text);
            font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif
        }

        .wrap {
            max-width: 1080px;
            margin: 40px auto;
            padding: 0 16px
        }

        .card {
            background: var(--card);
            border: 1px solid #23283a;
            border-radius: 16px;
            box-shadow: 0 10px 28px rgba(0,0,0,.35);
            padding: 20px
        }

        h1 {
            margin: 0 0 10px;
            font-size: 22px
        }

        .toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }

        .btn {
            appearance: none;
            border: none;
            border-radius: 12px;
            padding: 12px 16px;
            font-weight: 700;
            cursor: pointer
        }

        .btn-acc {
            background: linear-gradient(180deg,#ff5a19,#ff3000);
            color: #fff
        }

        .btn-ghost {
            background: #1a2030;
            color: #e9edff;
            border: 1px solid #2a3149
        }

        .btn[disabled] {
            opacity: .5;
            cursor: not-allowed
        }

        textarea {
            width: 100%;
            min-height: 220px;
            background: #0c0f17;
            color: var(--text);
            border: 1px solid #23283a;
            border-radius: 12px;
            padding: 12px;
            line-height: 1.5
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            background: #0c0f17;
            color: var(--text);
            border: 1px solid #23283a;
            border-radius: 12px;
            padding: 10px 12px
        }

        label {
            display: block;
            font-size: 12px;
            color: var(--muted);
            margin: 8px 2px
        }

        .row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap
        }

        .col {
            flex: 1 1 320px
        }

        .list {
            max-height: 260px;
            overflow: auto;
            border: 1px dashed #2a3149;
            border-radius: 12px;
            padding: 10px
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #2a3149;
            background: #121626;
            border-radius: 999px;
            padding: 6px 10px;
            margin: 5px 6px;
            color: #cfd7ff;
            font-size: 12px
        }

        .hint {
            color: var(--muted);
            font-size: 12px
        }

        .mono {
            font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace
        }

        table {
            width: 100%;
            border-collapse: collapse
        }

        th, td {
            padding: 10px;
            border-bottom: 1px solid #23283a;
            font-size: 13px
        }

        th {
            color: #9fb2ff;
            text-align: left
        }

        .bar {
            height: 8px;
            background: #1a2030;
            border: 1px solid #2a3149;
            border-radius: 999px;
            overflow: hidden
        }

            .bar > span {
                display: block;
                height: 100%;
                background: linear-gradient(90deg,#3867ff,#00e0ff)
            }

        .status {
            font-size: 12px
        }

        .s-ok {
            color: var(--ok)
        }

        .s-warn {
            color: var(--warn)
        }

        .s-err {
            color: var(--err)
        }

        .s-run {
            color: #61dafb
        }

        .drop {
            border: 2px dashed #2a3149;
            border-radius: 12px;
            padding: 18px;
            text-align: center;
            color: #9aa7d4
        }

            .drop.drag {
                background: #0d1220
            }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999
        }

            .modal .box {
                background: #141826;
                border: 1px solid #2a3149;
                border-radius: 14px;
                max-width: 520px;
                width: 92%;
                padding: 18px;
                color: #e9edff;
                box-shadow: 0 10px 28px rgba(0,0,0,.35)
            }

            .modal .row {
                display: grid;
                gap: 8px
            }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="card">
            <h1>ë©€í‹° URL ë‹¤ìš´ë¡œë” v3 â€” <span class="mono">íŒŒì¼ëª…-ì‹œì‘ë²ˆí˜¸.í™•ì¥ì</span></h1>
            <div class="toolbar" style="margin:8px 0 16px">
                <button id="pickDir" class="btn btn-ghost">ğŸ“ í´ë” ì €ì¥(ê¶Œì¥, Chrome/HTTPS)</button>
                <button id="startBtn" class="btn btn-acc">â¬‡ï¸ ë‹¤ìš´ë¡œë“œ ì‹œì‘</button>
                <button id="extractBtn" class="btn btn-ghost">ğŸ” URL ì¶”ì¶œ</button>
                <a href="autoFinal.html">
                    <button id="Btn2" class="btn btn-ghost">íŒŒì¼ê²½ë¡œ ìë™ì™„ì„±</button>
                </a>
                <a href="optionMaker_final.html">
                    <button id="Btn2" class="btn btn-ghost">ì˜µì…˜ìƒì„±ê¸°</button>
                </a>
            </div>

            <div class="row">
                <div class="col">
                    <label>ì—¬ê¸°ì— URL ë˜ëŠ” í…ìŠ¤íŠ¸(íƒœê·¸ ë¶ˆì™„ì „í•´ë„ OK) ë¶™ì—¬ë„£ê¸°</label>
                    <div id="drop" class="drop">í´ë¦­/ë¶™ì—¬ë„£ê¸° ë˜ëŠ” íŒŒì¼(HTML, TXT) ë“œë˜ê·¸Â·ë“œë¡­</div>
                    <textarea id="input" placeholder="ì˜ˆ) https://site.com/a.jpg (í…ìŠ¤íŠ¸ ì•ˆì˜ URLë§Œ ì¸ì‹í•©ë‹ˆë‹¤.)"></textarea>
                    <div class="hint">â€» GitHub Pages(HTTPS)ì—ì„œ ë™ì‘. ZIP ëŒ€ì‹  ë‹¤ì¤‘ íŒŒì¼ ì €ì¥ì„ ê¸°ë³¸ìœ¼ë¡œ í•˜ì—¬ Windows ì°¨ë‹¨ ì´ìŠˆ íšŒí”¼.</div>
                </div>
                <div class="col">
                    <label>íŒŒì¼ëª… ì ‘ë‘ì‚¬ (ì˜ˆ: myfile)</label>
                    <input id="prefix" type="text" placeholder="ì˜ˆ: myfile" />
                    <label>ì‹œì‘ ë²ˆí˜¸ (ì˜ˆ: 7 â†’ myfile-7, myfile-8, ...)</label>
                    <input id="startNum" type="number" min="0" value="1" />
                    <div class="row" style="margin-top:8px">
                        <div class="col">
                            <label>ì €ì¥ ë°©ì‹</label>
                            <select id="saveMode">
                                <option value="dir" selected>í´ë”ì— ë°”ë¡œ ì €ì¥ (ê¶Œì¥)</option>
                                <option value="multi">ë¸Œë¼ìš°ì € ê°œë³„ ì €ì¥(ì—¬ëŸ¬ íŒŒì¼)</option>
                                <option value="zip">ZIPë¡œ ë¬¶ê¸°(Windowsì—ì„œ ì°¨ë‹¨ë  ìˆ˜ ìˆìŒ)</option>
                            </select>
                        </div>
                        <div class="col">
                            <label>ë™ì‹œ ë‹¤ìš´ë¡œë“œ</label>
                            <input id="concurrency" type="number" min="1" max="8" value="1" />
                        </div>
                    </div>
                    <div class="row" style="margin-top:8px">
                        <div class="col">
                            <label>ìš”ì²­ íƒ€ì„ì•„ì›ƒ(ì´ˆ)</label>
                            <input id="timeout" type="number" min="5" max="120" value="60" />
                        </div>
                        <div class="col">
                            <label>í™•ì¥ì ê²°ì •</label>
                            <select id="extPolicy">
                                <option value="url-first" selected>URL ê²½ë¡œ ìš°ì„  â†’ MIME ë³´ì™„</option>
                                <option value="mime-only">MIMEë§Œ ì‚¬ìš©</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top:14px">
                <label>ì¶”ì¶œëœ URL (ì…ë ¥ ìˆœì„œ ìœ ì§€Â·ì¤‘ë³µ í—ˆìš©)</label>
                <div id="urlList" class="list"></div>
            </div>

            <div style="margin-top:14px">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
                    <div style="display:flex;gap:8px;align-items:center">
                        <div class="bar" style="width:320px"><span id="pbar" style="width:0%"></span></div>
                        <span id="ptext" class="hint">0%</span>
                    </div>
                    <div class="hint">ìƒíƒœ: <span id="status" class="status s-run">ëŒ€ê¸°</span></div>
                </div>
                <div style="overflow:auto;max-height:260px;margin-top:10px">
                    <table id="tbl"><thead><tr><th>#</th><th>URL</th><th>íŒŒì¼ëª…</th><th>ê²°ê³¼</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <!-- íŒŒì¼ëª… ì¶©ëŒ ëª¨ë‹¬ -->
    <div id="conflictModal" class="modal">
        <div class="box">
            <div style="font-weight:800;font-size:16px;margin-bottom:8px">íŒŒì¼ëª… ì¶©ëŒ</div>
            <div id="cf-name" style="font-size:13px;color:#9aa3ba;margin-bottom:10px"></div>
            <div class="row" style="margin-bottom:10px">
                <label style="display:flex;gap:8px;align-items:center"><input type="radio" name="cf" value="overwrite" checked> 1) ë®ì–´ì“°ê¸°</label>
                <label style="display:flex;gap:8px;align-items:center"><input type="radio" name="cf" value="skip"> 2) ê±´ë„ˆë›°ê¸°</label>
                <label style="display:flex;gap:8px;align-items:center"><input type="radio" name="cf" value="append"> 3) ì´ì–´ì“°ê¸° (ë’¤ì— (ìˆ«ì))</label>
            </div>
            <label style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
                <input type="checkbox" id="cf-applyall"> ì´í›„ ì¶©ëŒì—ë„ ë™ì¼ ì ìš©
            </label>
            <div style="display:flex;gap:8px;justify-content:flex-end">
                <button id="cf-cancel" class="btn btn-ghost">ì·¨ì†Œ</button>
                <button id="cf-ok" class="btn btn-acc">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- ê°€ê³µ ì˜µì…˜ ëª¨ë‹¬ (ì›ë³¸ / JPG ë³€í™˜+ë¦¬ì‚¬ì´ì¦ˆ+ìš©ëŸ‰ %) -->
    <div id="procModal" class="modal">
        <div class="box">
            <div style="font-weight:800;font-size:16px;margin-bottom:8px">ì´ë¯¸ì§€ ê°€ê³µ ì˜µì…˜ (GIF ì œì™¸)</div>
            <div class="row" style="margin-bottom:8px">
                <div class="hint">â€» GIFëŠ” í•­ìƒ ì›ë³¸ ê·¸ëŒ€ë¡œ ì €ì¥í•©ë‹ˆë‹¤. ê·¸ ì™¸ ì´ë¯¸ì§€(PNG/WEBP/AVIF/SVG ë“±)ëŠ” ì•„ë˜ì—ì„œ "ì›ë³¸"ì„ ê³ ë¥´ë©´ ë³€í™˜ ì—†ì´ ì €ì¥í•˜ê³ , í¬ê¸°ë¥¼ ê³ ë¥´ë©´ JPGë¡œ ë³€í™˜Â·ë¦¬ì‚¬ì´ì¦ˆ í›„ ìš©ëŸ‰ì„ ì¤„ì…ë‹ˆë‹¤. ì„ íƒí•œ í”½ì…€ì´ ì›ë³¸ë³´ë‹¤ í¬ë©´ ì—…ìŠ¤ì¼€ì¼í•©ë‹ˆë‹¤.</div>
            </div>
            <div class="row" style="margin-bottom:10px">
                <div>
                    <label style="margin:0 0 6px 2px">í¬ê¸° ì„ íƒ</label>
                    <label style="display:flex;gap:8px;align-items:center;margin-bottom:4px"><input type="radio" name="pmw" value="orig"> ì›ë³¸ ê·¸ëŒ€ë¡œ(ë³€í™˜/ë¦¬ì‚¬ì´ì¦ˆ/ì••ì¶• ì•ˆ í•¨)</label>
                    <label style="display:flex;gap:8px;align-items:center;margin-bottom:4px"><input type="radio" name="pmw" value="800" checked> 800 px</label>
                    <label style="display:flex;gap:8px;align-items:center"><input type="radio" name="pmw" value="1000"> 1000 px</label>
                </div>
                <div>
                    <label style="margin:0 0 6px 2px">ìš©ëŸ‰ ì¤„ì´ê¸°(%)</label>
                    <input id="pm-percent" type="number" min="0" max="95" value="30" />
                    <div class="hint">ì˜ˆ) 30 â†’ ì›ë³¸ ë°”ì´íŠ¸ ëŒ€ë¹„ ì•½ 30% ê°ëŸ‰ ëª©í‘œ(í’ˆì§ˆ ìë™ ì¡°ì •)</div>
                </div>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end">
                <button id="pm-cancel" class="btn btn-ghost">ì·¨ì†Œ</button>
                <button id="pm-ok" class="btn btn-acc">ì ìš©</button>
            </div>
        </div>
    </div>

    <script>
        (() => {
            const $ = (id) => document.getElementById(id);
            const els = {
                input: $('input'),
                drop: $('drop'),
                urlList: $('urlList'),
                prefix: $('prefix'),
                startNum: $('startNum'),
                saveMode: $('saveMode'),
                pickDirBtn: $('pickDir'),
                startBtn: $('startBtn'),
                concurrency: $('concurrency'),
                timeout: $('timeout'),
                extPolicy: $('extPolicy'),
                tblBody: document.querySelector('#tbl tbody'),
                pbar: $('pbar'),
                ptext: $('ptext'),
                status: $('status'),
                extractBtns: Array.from(document.querySelectorAll('#Btn1,#Btn2,#Btn3')),
                conflictModal: $('conflictModal'),
                procModal: $('procModal'),
            };

            let dirHandle = null;
            let urls = [];

            // ===== Utilities =====
            const extFromMimeMap = {
                'image/jpeg': 'jpg', 'image/jpg': 'jpg', 'image/png': 'png', 'image/webp': 'webp', 'image/gif': 'gif', 'image/bmp': 'bmp', 'image/svg+xml': 'svg', 'image/avif': 'avif',
                'video/mp4': 'mp4', 'video/webm': 'webm', 'video/quicktime': 'mov', 'application/pdf': 'pdf'
            };
            const extFromMime = (t) => extFromMimeMap[t?.toLowerCase?.()] || '';
            const extFromUrl = (u) => {
                try {
                    const p = new URL(u).pathname;
                    const base = p.split('/').pop() || '';
                    const clean = base.split('?')[0].split('#')[0];
                    const i = clean.lastIndexOf('.');
                    return (i > 0 ? clean.slice(i + 1).toLowerCase() : '');
                } catch { return '' }
            };
            const addRow = (i, url) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                <td>${i}</td>
                <td class="mono" style="word-break:break-all">${url}</td>
                <td class="mono name">â€”</td>
                <td class="result hint">ëŒ€ê¸°</td>`;
                els.tblBody.appendChild(tr);
                return { nameCell: tr.querySelector('.name'), resultCell: tr.querySelector('.result') };
            };
            const setProgress = (done, total) => {
                const pct = total ? Math.round((done / total) * 100) : 0;
                els.pbar.style.width = pct + '%';
                els.ptext.textContent = `${pct}% (${done}/${total})`;
            };

            // URL ì¶”ì¶œ (ê³µë°± ì—†ì´ ë¶™ì€ URL ë¶„ë¦¬ & ìŠ¤í‚´ ë³´ì •)
            function extractUrls(text) {
                const out = [];
                if (!text) return out;
                const fixed = text.replace(/https?:\s*\/\//gi, (m) =>
                    m.toLowerCase().startsWith('https') ? 'https://' : 'http://'
                );
                const re = /(https?:\/\/[^\s"'<>\)\(]+?)(?=(https?:\/\/)|[\s"'<>\)\(]|$)/gi;
                let m;
                while ((m = re.exec(fixed))) out.push(m[1]);
                const norm = [];
                for (const v of out) {
                    try {
                        const u = new URL(v);
                        if (u.protocol === 'http:' || u.protocol === 'https:') norm.push(u.toString());
                    } catch { }
                }
                return norm.filter(v => !v.startsWith('data:'));
            }

            function renderUrlChips() {
                els.urlList.innerHTML = urls.length
                    ? urls.map((u, i) => `<span class="pill"><span class="mono">${i + 1}</span> ${u}</span>`).join('')
                    : '<span class="hint">ì•„ì§ ì—†ìŒ</span>';
                els.tblBody.innerHTML = '';
                setProgress(0, urls.length);
                els.status.textContent = urls.length ? `URL ${urls.length}ê±´` : 'ëŒ€ê¸°';
            }

            async function pickDir() {
                try {
                    dirHandle = await window.showDirectoryPicker();
                    els.pickDirBtn.textContent = 'ğŸ“ í´ë” ì„ íƒë¨';
                    els.pickDirBtn.classList.add('btn-acc');
                } catch (e) {
                    if (e?.name !== 'AbortError') alert('í´ë” ì„ íƒ ì‹¤íŒ¨: ' + e.message);
                }
            }

            // íŒŒì¼ëª…: prefix-startIndex.ext
            function filenameAtIndex(basePrefix, start, idx, ext) {
                const n = (parseInt(start, 10) || 0) + idx;
                const safe = (basePrefix || '').trim();
                const e = (ext || 'bin').replace(/^\.+/, '');
                return `${safe}-${n}.${e}`;
            }

            // ===== ì¶©ëŒ ì²˜ë¦¬ =====
            let conflictPolicy = null; // 'overwrite' | 'skip' | 'append'
            function splitNameExt(name) {
                const i = name.lastIndexOf('.');
                return i > 0 ? { base: name.slice(0, i), ext: name.slice(i) } : { base: name, ext: '' };
            }
            async function fileExists(dir, name) { try { await dir.getFileHandle(name, { create: false }); return true; } catch { return false; } }
            function askConflict(name) {
                const modal = els.conflictModal;
                modal.style.display = 'flex';
                $('cf-name').textContent = `ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íŒŒì¼: ${name}`;
                $('cf-applyall').checked = false;
                return new Promise((resolve) => {
                    const ok = $('cf-ok'), cancel = $('cf-cancel');
                    const cleanup = () => { ok.onclick = null; cancel.onclick = null; modal.style.display = 'none'; };
                    cancel.onclick = () => { cleanup(); resolve('skip'); };
                    ok.onclick = () => {
                        const decision = [...document.querySelectorAll('input[name="cf"]')].find(r => r.checked).value;
                        const applyAll = $('cf-applyall').checked;
                        if (applyAll) conflictPolicy = decision;
                        cleanup(); resolve(decision);
                    };
                });
            }
            async function resolveTargetName(dir, name) {
                if (!(await fileExists(dir, name))) return name;
                const decision = conflictPolicy || await askConflict(name);
                if (decision === 'skip') return null;
                if (decision === 'overwrite') return name;
                const { base, ext } = splitNameExt(name); let k = 1, cand;
                while (await fileExists(dir, (cand = `${base}(${k})${ext}`))) k++;
                return cand;
            }

            // ===== ë„¤íŠ¸ì›Œí¬ =====
            async function fetchWithTimeout(url, ms) {
                const ctrl = new AbortController();
                const t = setTimeout(() => ctrl.abort('timeout'), ms);
                try { return await fetch(url, { signal: ctrl.signal, credentials: 'omit', mode: 'cors' }); }
                finally { clearTimeout(t); }
            }

            // ===== ì´ë¯¸ì§€ ê°€ê³µ =====
            // procSettings: { mode: 'original' } | { mode: 'process', width:number, reducePercent:number }
            let procSettings = null;

            function showProcModal() {
                const modal = els.procModal;
                modal.style.display = 'flex';
                return new Promise((resolve) => {
                    const ok = $('pm-ok'), cancel = $('pm-cancel');
                    const cleanup = () => { ok.onclick = null; cancel.onclick = null; modal.style.display = 'none'; };
                    cancel.onclick = () => { cleanup(); resolve(null); };
                    ok.onclick = () => {
                        const sel = modal.querySelector('input[name="pmw"]:checked');
                        const val = sel ? sel.value : '800';
                        if (val === 'orig') {
                            cleanup(); resolve({ mode: 'original' });
                        } else {
                            const w = Number(val);
                            const percent = Math.max(0, Math.min(95, parseInt(($('pm-percent').value || '30'), 10)));
                            cleanup(); resolve({ mode: 'process', width: w, reducePercent: percent });
                        }
                    };
                });
            }

            function isGif(mime, urlExt) {
                if (mime?.toLowerCase?.() === 'image/gif') return true;
                if ((urlExt || '').toLowerCase() === 'gif') return true;
                return false;
            }

            async function blobToImageBitmap(blob) {
                if ('createImageBitmap' in window) {
                    try { return await createImageBitmap(blob); } catch { }
                }
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = reject;
                    img.src = URL.createObjectURL(blob);
                });
            }

            async function drawToCanvasAndJpeg(blob, targetWidth) {
                const bmp = await blobToImageBitmap(blob);
                const srcW = bmp.width, srcH = bmp.height;
                const width = Number(targetWidth); // ì—…ìŠ¤ì¼€ì¼ í—ˆìš©: ì„ íƒí•œ ê°€ë¡œí­ìœ¼ë¡œ ê°•ì œ ë¦¬ì‚¬ì´ì¦ˆ
                const height = Math.round(srcH * (width / srcW));

                let canvas, ctx;
                if ('OffscreenCanvas' in window) {
                    canvas = new OffscreenCanvas(width, height);
                    ctx = canvas.getContext('2d', { alpha: false });
                } else {
                    canvas = document.createElement('canvas');
                    canvas.width = width; canvas.height = height;
                    ctx = canvas.getContext('2d', { alpha: false });
                }

                // JPGëŠ” ì•ŒíŒŒ ì—†ìŒ â†’ í°ìƒ‰ ë°”íƒ• ê¹”ê³  ê·¸ë¦¬ê¸°
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, width, height);
                ctx.drawImage(bmp, 0, 0, width, height);

                async function toJpegBlob(quality) {
                    return await new Promise((resolve) =>
                        ('convertToBlob' in canvas)
                            ? canvas.convertToBlob({ type: 'image/jpeg', quality }).then(resolve)
                            : canvas.toBlob(resolve, 'image/jpeg', quality)
                    );
                }
                return { toJpegBlob, width, height };
            }

            // ëª©í‘œ ë°”ì´íŠ¸ ê·¼ì‚¬ ì´ì§„íƒìƒ‰
            async function compressToTargetBytes(canvasExporter, targetBytes) {
                let lo = 0.1, hi = 0.95, bestBlob = null;
                for (let i = 0; i < 8; i++) {
                    const mid = (lo + hi) / 2;
                    const b = await canvasExporter.toJpegBlob(mid);
                    if (!bestBlob || b.size <= targetBytes) bestBlob = b;
                    if (b.size > targetBytes) hi = mid; else lo = mid;
                }
                if (!bestBlob) bestBlob = await canvasExporter.toJpegBlob(0.85);
                return bestBlob;
            }

            async function processImageIfNeeded(blob, url) {
                const mime = blob.type || '';
                const urlExt = extFromUrl(url);
                if (!mime.startsWith('image/')) return { blob, forcedExt: null, note: 'binary' };
                if (isGif(mime, urlExt)) return { blob, forcedExt: 'gif', note: 'gif-original' };

                // === ìƒˆ ì˜µì…˜: ì›ë³¸ ê·¸ëŒ€ë¡œ ì €ì¥ ===
                if (procSettings && procSettings.mode === 'original') {
                    return { blob, forcedExt: null, note: 'ì›ë³¸ ì €ì¥' };
                }

                // === í”„ë¡œì„¸ìŠ¤ ëª¨ë“œ ===
                const settings = (procSettings && procSettings.mode === 'process')
                    ? procSettings
                    : { mode: 'process', width: 800, reducePercent: 30 };

                const originalBytes = blob.size;
                const targetBytes = Math.max(1024, Math.round(originalBytes * (1 - settings.reducePercent / 100)));
                const exporter = await drawToCanvasAndJpeg(blob, Number(settings.width));
                const jpgBlob = await compressToTargetBytes(exporter, targetBytes);
                return { blob: jpgBlob, forcedExt: 'jpg', note: 'processed' };
            }

            // ===== ì‹¤í–‰ =====
            async function start() {
                // ë§¤ ë°°ì¹˜ ì‹œì‘ ì‹œ ì´ˆê¸°í™”(ì¶©ëŒ ì •ì±…ë§Œ)
                conflictPolicy = null;

                if (urls.length === 0) { alert('ì¶”ì¶œëœ URLì´ ì—†ìŠµë‹ˆë‹¤.'); return; }

                const prefix = $('prefix').value || 'file';
                const startNum = parseInt($('startNum').value || '1', 10);
                const timeoutMs = Math.max(5000, Math.min(120000, (parseInt(($('timeout').value || '60'), 10)) * 1000));
                const policy = $('extPolicy').value;

                let mode = $('saveMode').value;
                const fsSupported = !!window.showDirectoryPicker;
                if (mode === 'dir' && !fsSupported) mode = 'multi';
                const conc = (mode === 'dir') ? 1 : Math.max(1, Math.min(8, parseInt(($('concurrency').value || '3'), 10)));

                if (mode === 'dir' && !dirHandle) {
                    await pickDir();
                    if (!dirHandle) return;
                }

                // === ê°€ê³µ ì˜µì…˜ ëª¨ë‹¬(ë°°ì¹˜ë§ˆë‹¤ 1íšŒ) ===
                procSettings = await showProcModal();
                if (!procSettings) return; // ì·¨ì†Œ ì‹œ ì¢…ë£Œ

                els.startBtn.disabled = true;
                els.pickDirBtn.disabled = (mode === 'dir');
                els.extractBtns.forEach(b => b.disabled = true);
                els.status.textContent = 'ë‹¤ìš´ë¡œë“œ ì¤‘';
                els.status.className = 'status s-run';
                els.tblBody.innerHTML = '';

                let done = 0, ok = 0, fail = 0;
                const zip = (mode === 'zip') ? new JSZip() : null;

                const tasks = urls.map((u, i) => async () => {
                    const { nameCell, resultCell } = addRow(i + 1, u);
                    try {
                        const res = await fetchWithTimeout(u, timeoutMs);
                        if (!res.ok) throw new Error('HTTP ' + res.status);
                        const blob = await res.blob();

                        // í™•ì¥ì ê²°ì •(ê°€ê³µ ë¡œì§ì´ ê°•ì œí•˜ëŠ” ê²½ìš° ìš°ì„ )
                        let ext = '';
                        if (policy === 'url-first') {
                            ext = extFromUrl(u) || extFromMime(res.headers.get('content-type')) || extFromMime(blob.type) || 'bin';
                        } else {
                            ext = extFromMime(res.headers.get('content-type')) || extFromMime(blob.type) || 'bin';
                        }

                        // ì´ë¯¸ì§€ ê°€ê³µ/ì›ë³¸ ì €ì¥
                        const processed = await processImageIfNeeded(blob, u);
                        const outBlob = processed.blob;
                        if (processed.forcedExt) ext = processed.forcedExt; // JPG ê°•ì œ / GIF ìœ ì§€

                        const baseName = filenameAtIndex(prefix, startNum, i, ext);
                        let finalName = baseName;

                        if (mode === 'dir') {
                            const target = await resolveTargetName(dirHandle, baseName);
                            if (target === null) {
                                nameCell.textContent = baseName;
                                resultCell.textContent = 'ê±´ë„ˆëœ€(ì¤‘ë³µ)';
                                resultCell.className = 'result s-warn';
                                ok++; return;
                            }
                            finalName = target;
                            const fh = await dirHandle.getFileHandle(finalName, { create: true });
                            const w = await fh.createWritable();
                            await w.write(outBlob); await w.close();
                            nameCell.textContent = finalName;
                        } else if (mode === 'multi') {
                            const a = document.createElement('a');
                            a.href = URL.createObjectURL(outBlob);
                            a.download = baseName;
                            a.style.display = 'none';
                            document.body.appendChild(a); a.click();
                            setTimeout(() => URL.revokeObjectURL(a.href), 10000);
                            a.remove();
                            nameCell.textContent = baseName;
                        } else { // zip
                            const ab = await outBlob.arrayBuffer();
                            zip.file(baseName, ab);
                            nameCell.textContent = baseName;
                        }

                        let noteText = 'ì €ì¥ë¨';
                        if (processed.note === 'gif-original') noteText = 'ì €ì¥ë¨(ì›ë³¸ GIF)';
                        else if (processed.note === 'processed') noteText = 'ì €ì¥ë¨(JPG ë³€í™˜Â·ë¦¬ì‚¬ì´ì¦ˆÂ·ì••ì¶•)';
                        else if (processed.note === 'ì›ë³¸ ì €ì¥') noteText = 'ì €ì¥ë¨(ì›ë³¸)';

                        resultCell.textContent = noteText;
                        resultCell.className = 'result s-ok';
                        ok++;
                    } catch (e) {
                        resultCell.textContent = 'ì‹¤íŒ¨: ' + (e?.message || e);
                        resultCell.className = 'result s-err';
                        fail++;
                    } finally {
                        done++; setProgress(done, urls.length);
                        if (done === urls.length) finish();
                    }
                });

                async function runQueue() {
                    const runners = Array.from({ length: conc }, async (_, rIdx) => {
                        for (let j = rIdx; j < tasks.length; j += conc) { await tasks[j](); }
                    });
                    await Promise.allSettled(runners);
                    if (mode === 'zip') {
                        const blob = await zip.generateAsync({ type: 'blob' });
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = `${prefix}_batch.zip`;
                        document.body.appendChild(a); a.click();
                        setTimeout(() => URL.revokeObjectURL(a.href), 10000);
                        a.remove();
                    }
                }

                function finish() {
                    els.status.textContent = (fail ? `ì™„ë£Œ(ì„±ê³µ ${ok}, ì‹¤íŒ¨ ${fail})` : 'ì™„ë£Œ(ì „ì²´ ì„±ê³µ)');
                    els.status.className = fail ? 'status s-warn' : 'status s-ok';
                    els.startBtn.disabled = false;
                    els.pickDirBtn.disabled = false;
                    els.extractBtns.forEach(b => b.disabled = false);
                    conflictPolicy = null; // ë‹¤ìŒ ë°°ì¹˜ ì˜í–¥ ì œê±°
                }

                await runQueue();
            }

            function extract() { urls = extractUrls($('input').value); renderUrlChips(); }

            // === Events ===
            els.extractBtns.forEach(b => b.addEventListener('click', extract));
            els.startBtn.addEventListener('click', start);
            els.pickDirBtn.addEventListener('click', pickDir);
            $('input').addEventListener('input', () => { clearTimeout(window.__tmr); window.__tmr = setTimeout(extract, 300); });

            // Drop & paste
            ['dragenter', 'dragover'].forEach(ev => $('drop').addEventListener(ev, (e) => { e.preventDefault(); $('drop').classList.add('drag'); }));
            ['dragleave', 'drop'].forEach(ev => $('drop').addEventListener(ev, (e) => { e.preventDefault(); $('drop').classList.remove('drag'); }));
            $('drop').addEventListener('drop', async (e) => { const f = e.dataTransfer.files?.[0]; if (!f) return; const text = await f.text(); $('input').value = ($('input').value ? $('input').value + '\n' : '') + text; extract(); });
            $('drop').addEventListener('paste', (e) => { const t = e.clipboardData?.getData('text'); if (t) { $('input').value = ($('input').value ? $('input').value + '\n' : '') + t; extract(); } });
            $('drop').addEventListener('click', () => $('input').focus());

            // Init
            extract();
        })();
    </script>

    <div class="hint" style="max-width:1080px;margin:8px auto;padding:0 16px">
        â“˜ ì°¸ê³ : WindowsëŠ” ë¸Œë¼ìš°ì €ì—ì„œ ë°›ì€ ZIP íŒŒì¼ì— "ì¸í„°ë„·ì—ì„œ ë‹¤ìš´ë¡œë“œ" í‘œì‹ì„ ë‚¨ê²¨ íƒìƒ‰ê¸°ì—ì„œ ì°¨ë‹¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        ì´ ë¬¸ì œë¥¼ íšŒí”¼í•˜ë ¤ë©´ "í´ë”ì— ë°”ë¡œ ì €ì¥" ë˜ëŠ” "ë¸Œë¼ìš°ì € ê°œë³„ ì €ì¥"ì„ ì‚¬ìš©í•˜ì„¸ìš”. ZIPì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤ë©´, ZIP íŒŒì¼ ìš°í´ë¦­ â†’ ì†ì„± â†’ "ì°¨ë‹¨ í•´ì œ" ì²´í¬ í›„ ì ìš©.
    </div>
</body>
</html>
